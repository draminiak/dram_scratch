"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.naclRules = exports.interfaceEndpoints = exports.flowLogs = exports.vpcInit = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const nacl_1 = require("./nacl");
function vpcInit(stack, props) {
    // A Virtual Private Cloud runs everything in a private context. The
    // instances inside it can talk to each other via the private subnet, but
    // to connect to the open Internet, a gateway and security groups are needed.
    const constructId = 'Vpc';
    let vpcProps = {
        ipAddresses: aws_cdk_lib_1.aws_ec2.IpAddresses.cidr('10.0.0.0/16'),
        natGateways: 1,
        maxAzs: 3,
        subnetConfiguration: [
            {
                name: `${constructId}Public`,
                subnetType: aws_cdk_lib_1.aws_ec2.SubnetType.PUBLIC,
            },
            {
                name: `${constructId}PrivateWithEgress`,
                subnetType: aws_cdk_lib_1.aws_ec2.SubnetType.PRIVATE_WITH_EGRESS,
            },
            {
                name: `${constructId}PrivateIsolated`,
                subnetType: aws_cdk_lib_1.aws_ec2.SubnetType.PRIVATE_ISOLATED,
            },
        ],
    };
    // Nat Gateway
    let natGatewayProvider;
    if (!props.natGatewayEip) {
        natGatewayProvider = aws_cdk_lib_1.aws_ec2.NatProvider.gateway({ eipAllocationIds: undefined });
    }
    else {
        natGatewayProvider = aws_cdk_lib_1.aws_ec2.NatProvider.gateway({ eipAllocationIds: [props.natGatewayEip] });
    }
    vpcProps = Object.assign(Object.assign({}, vpcProps), { natGatewayProvider: natGatewayProvider });
    return new aws_cdk_lib_1.aws_ec2.Vpc(stack, constructId, vpcProps);
}
exports.vpcInit = vpcInit;
function flowLogs(stack, props) {
    // Setup IAM user for logs
    const flowRole = new aws_cdk_lib_1.aws_iam.Role(stack, 'FlowLog', {
        assumedBy: new aws_cdk_lib_1.aws_iam.ServicePrincipal('vpc-flow-logs.amazonaws.com')
    });
    // Setup VPC flow logs
    new aws_cdk_lib_1.aws_ec2.CfnFlowLog(stack, 'FlowLogs', {
        resourceId: props.vpc.vpcId,
        resourceType: 'VPC',
        trafficType: 'ALL',
        deliverLogsPermissionArn: flowRole.roleArn,
        logDestinationType: 'cloud-watch-logs',
        logGroupName: props.logGroup.logGroupName
    });
}
exports.flowLogs = flowLogs;
/**
 * Builds VPC endpoints to access AWS services without using NAT Gateway.
 */
function interfaceEndpoints(vpc) {
    // Allow ECS to pull Docker images without using NAT Gateway
    // https://docs.aws.amazon.com/AmazonECR/latest/userguide/vpc-endpoints.html
    _addInterfaceEndpoint(vpc, "ECRDockerEndpoint", aws_cdk_lib_1.aws_ec2.InterfaceVpcEndpointAwsService.ECR_DOCKER);
    _addInterfaceEndpoint(vpc, "ECREndpoint", aws_cdk_lib_1.aws_ec2.InterfaceVpcEndpointAwsService.ECR);
    _addInterfaceEndpoint(vpc, "ElastiCache", aws_cdk_lib_1.aws_ec2.InterfaceVpcEndpointAwsService.ELASTICACHE);
    _addInterfaceEndpoint(vpc, "SecretManagerEndpoint", aws_cdk_lib_1.aws_ec2.InterfaceVpcEndpointAwsService.SECRETS_MANAGER);
    // _addInterfaceEndpoint(vpc, "CloudWatchEndpoint", ec2.InterfaceVpcEndpointAwsService.CLOUDWATCH);
    // _addInterfaceEndpoint(vpc, "CloudWatchLogsEndpoint", ec2.InterfaceVpcEndpointAwsService.CLOUDWATCH_LOGS);
    // _addInterfaceEndpoint(vpc, "CloudWatchEventsEndpoint", ec2.InterfaceVpcEndpointAwsService.CLOUDWATCH_EVENTS);
    _addInterfaceEndpoint(vpc, "SSMEndpoint", aws_cdk_lib_1.aws_ec2.InterfaceVpcEndpointAwsService.SSM);
}
exports.interfaceEndpoints = interfaceEndpoints;
function _addInterfaceEndpoint(vpc, name, awsService) {
    const endpoint = vpc.addInterfaceEndpoint(`${name}`, {
        service: awsService
    });
    endpoint.connections.allowFrom(aws_cdk_lib_1.aws_ec2.Peer.ipv4(vpc.vpcCidrBlock), endpoint.connections.defaultPort);
}
/** Nacl Rules **/
function naclRules(stack, vpc) {
    /** Nacl restrict Public subnet */
    const publicNacl = new aws_cdk_lib_1.aws_ec2.NetworkAcl(stack, 'PublicNacl', {
        vpc: vpc,
        networkAclName: 'PublicNacl',
        subnetSelection: { subnetType: aws_cdk_lib_1.aws_ec2.SubnetType.PUBLIC }
    });
    (0, nacl_1.addNaclRules)(publicNacl);
    /** Nacl restrict Private subnet */
    const privateNacl = new aws_cdk_lib_1.aws_ec2.NetworkAcl(stack, 'PrivateNacl', {
        vpc: vpc,
        networkAclName: 'PrivateNacl',
        subnetSelection: { subnetType: aws_cdk_lib_1.aws_ec2.SubnetType.PRIVATE_WITH_EGRESS }
    });
    (0, nacl_1.addNaclRules)(privateNacl);
}
exports.naclRules = naclRules;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidnBjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidnBjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUlxQjtBQUVyQixpQ0FBb0M7QUFNcEMsU0FBZ0IsT0FBTyxDQUFDLEtBQWdCLEVBQUUsS0FBbUI7SUFDekQsb0VBQW9FO0lBQ3BFLHlFQUF5RTtJQUN6RSw2RUFBNkU7SUFDN0UsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDO0lBRTFCLElBQUksUUFBUSxHQUFpQjtRQUN6QixXQUFXLEVBQUUscUJBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQztRQUNoRCxXQUFXLEVBQUUsQ0FBQztRQUNkLE1BQU0sRUFBRSxDQUFDO1FBQ1QsbUJBQW1CLEVBQUU7WUFDakI7Z0JBQ0ksSUFBSSxFQUFFLEdBQUcsV0FBVyxRQUFRO2dCQUM1QixVQUFVLEVBQUUscUJBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTTthQUNwQztZQUNEO2dCQUNJLElBQUksRUFBRSxHQUFHLFdBQVcsbUJBQW1CO2dCQUN2QyxVQUFVLEVBQUUscUJBQUcsQ0FBQyxVQUFVLENBQUMsbUJBQW1CO2FBQ2pEO1lBQ0Q7Z0JBQ0ksSUFBSSxFQUFFLEdBQUcsV0FBVyxpQkFBaUI7Z0JBQ3JDLFVBQVUsRUFBRSxxQkFBRyxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0I7YUFDOUM7U0FDSjtLQUNKLENBQUM7SUFFRixjQUFjO0lBQ2QsSUFBSSxrQkFBbUMsQ0FBQztJQUN4QyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRTtRQUN0QixrQkFBa0IsR0FBRyxxQkFBRyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBQyxnQkFBZ0IsRUFBRSxTQUFTLEVBQUMsQ0FBQyxDQUFBO0tBQzlFO1NBQU07UUFDSCxrQkFBa0IsR0FBRyxxQkFBRyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBQyxnQkFBZ0IsRUFBRSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsRUFB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QUU7UUFDekQsR0FBRyxFQUFFLEdBQUc7UUFDUixjQUFjLEVBQUUsYUFBYTtRQUM3QixlQUFlLEVBQUUsRUFBRSxVQUFVLEVBQUUscUJBQUcsQ0FBQyxVQUFVLENBQUMsbUJBQW1CLEVBQUU7S0FDdEUsQ0FBQyxDQUFDO0lBQ0gsSUFBQSxtQkFBWSxFQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQzlCLENBQUM7QUFoQkQsOEJBZ0JDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBhd3NfZWMyIGFzIGVjMixcbiAgICBhd3NfaWFtIGFzIGlhbSxcbiAgICBhd3NfbG9ncyBhcyBsb2dzLFxufSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7Q29uc3RydWN0fSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHthZGROYWNsUnVsZXN9IGZyb20gXCIuL25hY2xcIjtcblxuaW50ZXJmYWNlIFZwY0luaXRQcm9wcyB7XG4gICAgcmVhZG9ubHkgbmF0R2F0ZXdheUVpcD86IHN0cmluZ1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdnBjSW5pdChzdGFjazogQ29uc3RydWN0LCBwcm9wczogVnBjSW5pdFByb3BzKTogZWMyLlZwYyB7XG4gICAgLy8gQSBWaXJ0dWFsIFByaXZhdGUgQ2xvdWQgcnVucyBldmVyeXRoaW5nIGluIGEgcHJpdmF0ZSBjb250ZXh0LiBUaGVcbiAgICAvLyBpbnN0YW5jZXMgaW5zaWRlIGl0IGNhbiB0YWxrIHRvIGVhY2ggb3RoZXIgdmlhIHRoZSBwcml2YXRlIHN1Ym5ldCwgYnV0XG4gICAgLy8gdG8gY29ubmVjdCB0byB0aGUgb3BlbiBJbnRlcm5ldCwgYSBnYXRld2F5IGFuZCBzZWN1cml0eSBncm91cHMgYXJlIG5lZWRlZC5cbiAgICBjb25zdCBjb25zdHJ1Y3RJZCA9ICdWcGMnO1xuXG4gICAgbGV0IHZwY1Byb3BzOiBlYzIuVnBjUHJvcHMgPSB7XG4gICAgICAgIGlwQWRkcmVzc2VzOiBlYzIuSXBBZGRyZXNzZXMuY2lkcignMTAuMC4wLjAvMTYnKSxcbiAgICAgICAgbmF0R2F0ZXdheXM6IDEsXG4gICAgICAgIG1heEF6czogMyxcbiAgICAgICAgc3VibmV0Q29uZmlndXJhdGlvbjogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG5hbWU6IGAke2NvbnN0cnVjdElkfVB1YmxpY2AsXG4gICAgICAgICAgICAgICAgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFVCTElDLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiBgJHtjb25zdHJ1Y3RJZH1Qcml2YXRlV2l0aEVncmVzc2AsXG4gICAgICAgICAgICAgICAgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9XSVRIX0VHUkVTUyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbmFtZTogYCR7Y29uc3RydWN0SWR9UHJpdmF0ZUlzb2xhdGVkYCxcbiAgICAgICAgICAgICAgICBzdWJuZXRUeXBlOiBlYzIuU3VibmV0VHlwZS5QUklWQVRFX0lTT0xBVEVELFxuICAgICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICB9O1xuXG4gICAgLy8gTmF0IEdhdGV3YXlcbiAgICBsZXQgbmF0R2F0ZXdheVByb3ZpZGVyOiBlYzIuTmF0UHJvdmlkZXI7XG4gICAgaWYgKCFwcm9wcy5uYXRHYXRld2F5RWlwKSB7XG4gICAgICAgIG5hdEdhdGV3YXlQcm92aWRlciA9IGVjMi5OYXRQcm92aWRlci5nYXRld2F5KHtlaXBBbGxvY2F0aW9uSWRzOiB1bmRlZmluZWR9KVxuICAgIH0gZWxzZSB7XG4gICAgICAgIG5hdEdhdGV3YXlQcm92aWRlciA9IGVjMi5OYXRQcm92aWRlci5nYXRld2F5KHtlaXBBbGxvY2F0aW9uSWRzOiBbcHJvcHMubmF0R2F0ZXdheUVpcF19KVxuICAgIH1cblxuICAgIHZwY1Byb3BzID0ge1xuICAgICAgICAuLi52cGNQcm9wcyxcbiAgICAgICAgbmF0R2F0ZXdheVByb3ZpZGVyOiBuYXRHYXRld2F5UHJvdmlkZXJcbiAgICB9O1xuICAgIHJldHVybiBuZXcgZWMyLlZwYyhzdGFjaywgY29uc3RydWN0SWQsIHZwY1Byb3BzKTtcbn1cblxuLyoqXG4gKiBWcGMgRmxvdyBMb2dzXG4gKi9cbmludGVyZmFjZSBmbG93TG9nc1Byb3BzIHtcbiAgICByZWFkb25seSBsb2dHcm91cDogbG9ncy5Mb2dHcm91cFxuICAgIHJlYWRvbmx5IHZwYzogZWMyLlZwY1xufVxuZXhwb3J0IGZ1bmN0aW9uIGZsb3dMb2dzKHN0YWNrOiBDb25zdHJ1Y3QsIHByb3BzOiBmbG93TG9nc1Byb3BzKSB7XG4gICAgLy8gU2V0dXAgSUFNIHVzZXIgZm9yIGxvZ3NcbiAgICBjb25zdCBmbG93Um9sZSA9IG5ldyBpYW0uUm9sZShzdGFjaywgJ0Zsb3dMb2cnLCB7XG4gICAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKCd2cGMtZmxvdy1sb2dzLmFtYXpvbmF3cy5jb20nKVxuICAgIH0pO1xuXG4gICAgLy8gU2V0dXAgVlBDIGZsb3cgbG9nc1xuICAgIG5ldyBlYzIuQ2ZuRmxvd0xvZyhzdGFjaywgJ0Zsb3dMb2dzJywge1xuICAgICAgICByZXNvdXJjZUlkOiBwcm9wcy52cGMudnBjSWQsXG4gICAgICAgIHJlc291cmNlVHlwZTogJ1ZQQycsXG4gICAgICAgIHRyYWZmaWNUeXBlOiAnQUxMJyxcbiAgICAgICAgZGVsaXZlckxvZ3NQZXJtaXNzaW9uQXJuOiBmbG93Um9sZS5yb2xlQXJuLFxuICAgICAgICBsb2dEZXN0aW5hdGlvblR5cGU6ICdjbG91ZC13YXRjaC1sb2dzJyxcbiAgICAgICAgbG9nR3JvdXBOYW1lOiBwcm9wcy5sb2dHcm91cC5sb2dHcm91cE5hbWVcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBCdWlsZHMgVlBDIGVuZHBvaW50cyB0byBhY2Nlc3MgQVdTIHNlcnZpY2VzIHdpdGhvdXQgdXNpbmcgTkFUIEdhdGV3YXkuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbnRlcmZhY2VFbmRwb2ludHModnBjOiBlYzIuVnBjKTogdm9pZCB7XG4gICAgLy8gQWxsb3cgRUNTIHRvIHB1bGwgRG9ja2VyIGltYWdlcyB3aXRob3V0IHVzaW5nIE5BVCBHYXRld2F5XG4gICAgLy8gaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FtYXpvbkVDUi9sYXRlc3QvdXNlcmd1aWRlL3ZwYy1lbmRwb2ludHMuaHRtbFxuICAgIF9hZGRJbnRlcmZhY2VFbmRwb2ludCh2cGMsIFwiRUNSRG9ja2VyRW5kcG9pbnRcIiwgZWMyLkludGVyZmFjZVZwY0VuZHBvaW50QXdzU2VydmljZS5FQ1JfRE9DS0VSKTtcbiAgICBfYWRkSW50ZXJmYWNlRW5kcG9pbnQodnBjLCBcIkVDUkVuZHBvaW50XCIsIGVjMi5JbnRlcmZhY2VWcGNFbmRwb2ludEF3c1NlcnZpY2UuRUNSKTtcbiAgICBfYWRkSW50ZXJmYWNlRW5kcG9pbnQodnBjLCBcIkVsYXN0aUNhY2hlXCIsIGVjMi5JbnRlcmZhY2VWcGNFbmRwb2ludEF3c1NlcnZpY2UuRUxBU1RJQ0FDSEUpO1xuICAgIF9hZGRJbnRlcmZhY2VFbmRwb2ludCh2cGMsIFwiU2VjcmV0TWFuYWdlckVuZHBvaW50XCIsIGVjMi5JbnRlcmZhY2VWcGNFbmRwb2ludEF3c1NlcnZpY2UuU0VDUkVUU19NQU5BR0VSKTtcbiAgICAvLyBfYWRkSW50ZXJmYWNlRW5kcG9pbnQodnBjLCBcIkNsb3VkV2F0Y2hFbmRwb2ludFwiLCBlYzIuSW50ZXJmYWNlVnBjRW5kcG9pbnRBd3NTZXJ2aWNlLkNMT1VEV0FUQ0gpO1xuICAgIC8vIF9hZGRJbnRlcmZhY2VFbmRwb2ludCh2cGMsIFwiQ2xvdWRXYXRjaExvZ3NFbmRwb2ludFwiLCBlYzIuSW50ZXJmYWNlVnBjRW5kcG9pbnRBd3NTZXJ2aWNlLkNMT1VEV0FUQ0hfTE9HUyk7XG4gICAgLy8gX2FkZEludGVyZmFjZUVuZHBvaW50KHZwYywgXCJDbG91ZFdhdGNoRXZlbnRzRW5kcG9pbnRcIiwgZWMyLkludGVyZmFjZVZwY0VuZHBvaW50QXdzU2VydmljZS5DTE9VRFdBVENIX0VWRU5UUyk7XG4gICAgX2FkZEludGVyZmFjZUVuZHBvaW50KHZwYywgXCJTU01FbmRwb2ludFwiLCBlYzIuSW50ZXJmYWNlVnBjRW5kcG9pbnRBd3NTZXJ2aWNlLlNTTSk7XG59XG5mdW5jdGlvbiBfYWRkSW50ZXJmYWNlRW5kcG9pbnQodnBjOiBlYzIuVnBjLCBuYW1lOiBzdHJpbmcsIGF3c1NlcnZpY2U6IGVjMi5JbnRlcmZhY2VWcGNFbmRwb2ludEF3c1NlcnZpY2UpOiB2b2lkIHtcbiAgICBjb25zdCBlbmRwb2ludDogZWMyLkludGVyZmFjZVZwY0VuZHBvaW50ID0gdnBjLmFkZEludGVyZmFjZUVuZHBvaW50KGAke25hbWV9YCwge1xuICAgICAgICBzZXJ2aWNlOiBhd3NTZXJ2aWNlXG4gICAgfSk7XG4gICAgZW5kcG9pbnQuY29ubmVjdGlvbnMuYWxsb3dGcm9tKGVjMi5QZWVyLmlwdjQodnBjLnZwY0NpZHJCbG9jayksIGVuZHBvaW50LmNvbm5lY3Rpb25zLmRlZmF1bHRQb3J0ISk7XG59XG5cbi8qKiBOYWNsIFJ1bGVzICoqL1xuZXhwb3J0IGZ1bmN0aW9uIG5hY2xSdWxlcyhzdGFjazogQ29uc3RydWN0LCB2cGM6IGVjMi5WcGMpIHtcbiAgICAvKiogTmFjbCByZXN0cmljdCBQdWJsaWMgc3VibmV0ICovXG4gICAgY29uc3QgcHVibGljTmFjbCA9IG5ldyBlYzIuTmV0d29ya0FjbChzdGFjaywgJ1B1YmxpY05hY2wnLCB7XG4gICAgICAgIHZwYzogdnBjLFxuICAgICAgICBuZXR3b3JrQWNsTmFtZTogJ1B1YmxpY05hY2wnLFxuICAgICAgICBzdWJuZXRTZWxlY3Rpb246IHsgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFVCTElDIH1cbiAgICB9KTtcbiAgICBhZGROYWNsUnVsZXMocHVibGljTmFjbCk7XG5cbiAgICAvKiogTmFjbCByZXN0cmljdCBQcml2YXRlIHN1Ym5ldCAqL1xuICAgIGNvbnN0IHByaXZhdGVOYWNsID0gbmV3IGVjMi5OZXR3b3JrQWNsKHN0YWNrLCAnUHJpdmF0ZU5hY2wnLCB7XG4gICAgICAgIHZwYzogdnBjLFxuICAgICAgICBuZXR3b3JrQWNsTmFtZTogJ1ByaXZhdGVOYWNsJyxcbiAgICAgICAgc3VibmV0U2VsZWN0aW9uOiB7IHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBSSVZBVEVfV0lUSF9FR1JFU1MgfVxuICAgIH0pO1xuICAgIGFkZE5hY2xSdWxlcyhwcml2YXRlTmFjbCk7XG59XG4iXX0=